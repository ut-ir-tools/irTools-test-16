
# Data processing

## Data validation
Table-based validation. Functions to update & apply data validation tables, generate data with consistent nomenclature.  
1. Labs & activity types  
2. Activity media  
3. Parameter names & fractions  
4. Detection conditions  
5. Detection limit types  
6. Unit conversion factors  
<br><br><br>

```{r, id-transwb, echo=FALSE}
translation_wb="00-lookup-tables\\ir_translation_workbook.xlsx"
```

### Update detection condition / limit name tables
```{r, update-detcondlim}
updateDetCondLimTables(results=irdata$merged_results, detquantlim=irdata$detquantlim, translation_wb=translation_wb,
						detConditionTable_startRow=2, detLimitTypeTable_startRow=2)
```


### Fill masked/censored values in results
```{r, fill-masked}
merged_results_filled=fillMaskedValues(results=irdata$merged_results, detquantlim=irdata$detquantlim, translation_wb=translation_wb,
									   detLimitTypeTable_sheetname="detLimitTypeTable", detLimitTypeTable_startRow=2,
									   unitConvTable_sheetname="unitConvTable", unitConvTable_startRow=1, unitConvTable_startCol=1,
									   lql_fac=0.5, uql_fac=1)
```

### Update lab/activity & media tables
```{r, labactmedia}
updateLabActMediaTables(merged_results_filled, translation_wb=translation_wb, labNameActivityTable_startRow = 2)
```


### Apply screening tables
```{r, screening-tables}
mrf_screened=applyScreenTable(merged_results_filled,wb=translation_wb,
								sheetname="sites",startRow=2, flag_col_name="IR_Site_FLAG", com_col_name="IR_Site_COMMENT")

mrf_screened=applyScreenTable(mrf_screened,wb=translation_wb,
								sheetname="detConditionTable",startRow=2, flag_col_name="IR_DetCond_FLAG", com_col_name="IR_DetCond_COMMENT")

mrf_screened=applyScreenTable(mrf_screened,wb=translation_wb,
								sheetname="labNameActivityTable",startRow=2,flag_col_name="IR_LabAct_FLAG", com_col_name="IR_LabAct_COMMENT")

mrf_screened=applyScreenTable(mrf_screened,wb=translation_wb,
								sheetname="activityMediaNameTable",startRow=1, flag_col_name="IR_Media_FLAG", com_col_name="IR_Media_COMMENT")

```


### Subset data to desired flag types
```{r, screen-subset}
mrf_sub=subset(mrf_screened,
	IR_DetCond_FLAG=="ACCEPT" &
	IR_LabAct_FLAG=="ACCEPT" &
	IR_Media_FLAG=="ACCEPT" &
	IR_Site_FLAG =="ACCEPT")
	
dim(mrf_sub)
table(mrf_sub$IR_DetCond_FLAG)
table(mrf_sub$IR_LabAct_FLAG)
table(mrf_sub$IR_Media_FLAG)
table(mrf_sub$IR_Site_FLAG)
#table(mrf_sub$CharacteristicName)[table(mrf_sub$CharacteristicName)>0]
```

## Data prep
Generating assessable dataset  
1. Apply screening tables and subset to acceptable data  
2. Assigning criteria (by parameter & use via criteria table)  
3. Convert to consistent units (target units defined by criteria)  
4. Check that data fractions & activities match assessment targets  
5. Aggregate to daily values  
6. Generate correction factors & calculate criteria  
7. Split data into assessment groups  
<br><br>


### Update parameter translation tables
```{r, update-param-trans, eval=F}
updateParamTrans(data=mrf_sub, detquantlim=detquantlim,  translation_wb="00-lookup-tables\\ir_translation_workbook_live.xlsx")
```

### Apply parameter translation table
```{r, apply-param-trans}
mrf_sub_translated=applyScreenTable(mrf_sub,wb=translation_wb,
									sheetname="paramTransTable",startRow=4,flag_col_name="IR_Parameter_FLAG",com_col_name="IR_Parameter_COMMENT",
									na_dup_err=F)
```
### Subset data to ACCEPT parameters
```{r, sub-accept-params}
accepted_data=subset(mrf_sub_translated, IR_Parameter_FLAG=="ACCEPT")
knitr::kable(table(droplevels(accepted_data$CharacteristicName)))
```

### Criteria & unit assigments

#### Assign criteria
```{r, assign-criteria}
data_crit=assignCriteria(accepted_data, crit_wb="00-lookup-tables\\IR_uses_standards.xlsx",
								  crit_sheetname="criteria", ss_sheetname="ss_criteria", crit_startRow=1, ss_startRow=1, rm_nocrit=FALSE, print=FALSE)
#knitr::kable(table(droplevels(data_crit$CharacteristicName),data_crit$R3172ParameterName))
#DT::datatable(unique(data.frame(data_crit[,c('CharacteristicName','R3172ParameterName','BeneficialUse','NumericCriterion','CriterionUnits')])))
```

#### Update unit conversion table
```{r, update-unit-conv}
updateUnitConvTable(data_crit, translation_wb, sheetname = "unitConvTable")
```

### Final data prep step
```{r, data-prep}
prepped_data=dataPrep(data=data_crit, translation_wb=translation_wb, split_agg_tds=TRUE, crit_wb="00-lookup-tables\\IR_uses_standards.xlsx",
						unit_sheetname = "unitConvTable", startRow_unit = 1, cf_formulas_sheetname="cf_formulas", startRow_formulas=1)
attach(prepped_data)
```










